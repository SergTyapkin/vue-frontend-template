![GithubCI](https://github.com/sergtyapkin/vue-frontend-template/actions/workflows/deploy.yaml/badge.svg)

# Фронтенд на Vue.js с авто-деплоем на _Nginx_ в докере и автоматическим получением сертификатов _Letsencrypt_

Словом, всё необходимое, чтобы раскатить фронтенд за 10 минут на чистой машине с Ubuntu.

### Все сконфигурированные пакеты и инструменты сборки:

1. **Vite** - сборщик
2. **Typescript** - типизация для JS
3. **Vue.js** - высокоуровневый фреймворк
4. **Stylus** - препроцессор для css-стилей
5. **TypeDoc** - генератор HTML документации по JSDoc-комментариям
6. **Jest** - фреймворк для запуска юнит-тестов
7. **ESlint** - статический анализатор кода

> **Плагины ESLint:**
>
> - **JS / TS / Vue** - стандартные плагины
> - **Compat** - проверка совместимости со старыми браузерами
> - **No loops** - запрет использования "C-style" циклов for, while
> - **Sonarjs** - проверка когнитивной сложности больших блоков кода
> - **No use extend native** - запрет расширения классов стандартных типов данных
> - **Optimize regex** - проверка качества написания ругулярных выражений
> - **Promise** - проверка работы с промисами
> - **Import** - проверка и оптимизация импортов _(отключен из-за проблем использования вместе с Vue)_

8. **Prettier** - линтер для JS/TS
9. **Stylelint** - линтер для Stylus
10. **Husky/pre-commit** - инструменты для запуска линтеров перед каждым коммитом
11. **Nginx/Docker/Make** - инструменты для запуска собранного приложения в выделенном контейнере

#### Полный список команд Make:

```SHELL
make all  # Настроить env, установить докер, получить SSL-сертификаты, настроить автообновление сертификатов, запустить контейнер, настроить CI
make update  # Обновить код до последней версии из ветки, собрать образ и перезапустить контейнер
make build  # Собрать образ
make run  # Перезапустить контейнер
make down  # Остановить контейнер
make logs  # Вывести логи в интерактивном режиме
make generate-certs  # Получить SSL-сертификаты
make renew-certs  # Обновить SSL-сертификаты
make setup-ci  # Настроить CI, получить переменные для его настройки в Github
make install-docker-if-not-exists  # Установить докер, если его ещё нет
make set-docker-not-sudo  # Доавить текущего пользователя в группу docker, чтобы его можно было запускать без sudo
make generate-docker-compose  # Сгенерировать docker-compose.yaml по конфигурации из .env
make setup-env-file  # Создать .env, если его ещё нет, и открыть его в редакторе
```

## Развертка для разработки

```SHELL
npm run dev
```

_У вас должна быть установлена `node`. [Установка Node.js](https://nodejs.org/en/download)_

# Развертка в деплой

Развертка выполняется через команды в `Makefile`

## 1. Клонируем репозиторий:

```SHELL
git clone git@github.com:SergTyapkin/vue-frontend-template.git
```

## 2. Настраиваем вообще всё.

В самом начале нужно будет настроить `.env` файл:

> - `EXTERNAL_DOCKER_NETWORK_NAME` - если указано, подключается к существующей сети докера (какой-то прокси), как к external сети
> - `API_HOST`, `API_PORT` - адрес проксирования на API. Если проксируется внутри сети докера, указывается _название контейнера_ как хост и его _внутренний_ порт
> - `VITE_DEPLOY_HOSTNAME` - хост сайта без https:// в начале
> - `VITE_HTTPS` - раздавать ли сайт по HTTPS, и получать ли для этого сертификаты. В случае, если _false_, раздача осуществляется только по HTTP, и DEPLOY_NGINX_PORT_HTTPS можно не указывать
> - `DEPLOY_NGINX_PORT_HTTP`, `DEPLOY_NGINX_PORT_HTTPS` - порты для раздачи сайта по HTTP и HTTPS. Если `VITE_HTTPS` в значении _false_, то раздача осуществляется только по HTTP

```SHELL
cd vue-frontend-template
make all # not just "make"!
```

Всё. Наслаждаемся тем, что за нас всё сделали, установили докер, сайт раздаётся, сертификаты обновляются.
Теперь `Github CI` сам будет проверять, собирается ли контейнер при **Pull Request**'ах, а при **Push**'ах в ветку `master` будет автоматически выполняться `make update` на сервере и обновлять деплой!

_После выполнения не забываем прописать переменные, значения которых команда выдала в консоль, в настройки окружения репозитория на Github, как это написано в пункте 3._

### Полный список действий скриптов

1. Устанавливает `docker`, если его ещё нет
2. Добавляет текущего пользователя в группу `Docker`, чтобы запускать его без `sudo`
3. Предлагает настроить `.env` файл
4. Получает сертификаты Letsencrypt
5. Устанавливает и настраивает `cron` на ежемесячное обновление сертификатов
6. Создаёт пару SSH ключей, публичный добавляет в `~/.ssh/authorized_keys`, приватный выводит в консоль, его нужно добавить как секретную переменную среды `SSH_DEPLOY_KEY` в настройках Github.
7. Собирает приложение из последнего коммита в ветку, указанную в `.env` файле, запускает финальный docker-контейнер с ним.
8. Показывает остальеые переменные, которые необходимо установить в настройках GitHub для настройки CI/CD.

## 3. Установка переменных

1. Заходим в `Settings` -> `Environments`, создаём новое окружение под названием `deploy` (важно).
   ![](/README_res/1.png)
2. Создаём внутри окружения все необходимые переменные. Их выведет `make all` после завершения выполнения, или можно прописать самому.
   ![](/README_res/2.png)
